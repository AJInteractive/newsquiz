/*! newsquiz - v0.1.0 - 2013-01-04
* https://github.com/motherjones/newsquiz
* Copyright (c) 2013 Ben Breedlove; Licensed MIT, GPL */
(function(a){a.quiz=function(b,c){var d,e,f=[],g,h={defaulting_behavior_on:!0,defaulting_flag:"!default",container:"quiz_container",init:function(a,b){e=this;if(b)for(var c in b)e[c]=b[c];if(typeof a=="string")return e.make_quiz_from_google_spreadsheet(a),e;e.calculate_aspectratios(a),e.quiz_data=a,e.create_cover();for(var d=0;d<e.quiz_data.length;d++)e.append_question(d);return e.append_how_you_did_section(),e},append_how_you_did_section:function(){g=jQuery('<span class="correct_answers">0</span>');var a=jQuery('<p class="how_you_did"></p>');a.append(jQuery("<span>You got </span>")),a.append(g),a.append(jQuery("<span> correct answers out of "+e.quiz_data.length+" questions</span>")),cover.append(a),cover.append(jQuery('<p class="small">on your first attempt. No fair changing your answers after you found out you were wrong</p>'))},make_quiz_from_google_spreadsheet:function(a){Tabletop.init({key:a,callback:function(a){var b=e.make_quiz_data_from_spreadsheet_data(a);e.init(b,c)},simpleSheet:!0})},calculate_aspectratios:function(a){for(var b=0;b<a.length;b++){var c=a[b];for(var d=0;d<c.possible_answers.length;d++){var f=c.possible_answers[d];e.find_aspectratio_for_each_type_of_video_embed(f)}e.find_aspectratio_for_each_type_of_video_embed(c.question)}},find_aspectratio_for_each_type_of_video_embed:function(a){var b=["top","middle","bottom"];for(var c=0;c<b.length;c++)a[b[c]+"videoembed"]&&(a[b[c]+"aspectratio"]=e.find_aspectratio(a[b[c]+"videoembed"]))},pull_answer_value_from_spreadsheet:function(a,b,c,d){var d=d?"right":"wrong";return a[d+c+b]&&a[d+c+b]!==e.defaulting_flag?a[d+c+b]:e.defaulting_behavior_on&&a[d+c+b]!==e.defaulting_flag||!e.defaulting_behavior_on&&a[d+c+b]===e.defaulting_flag?a[d+b]&&a[d+b]!==e.defaulting_flag?a[d+b]:a["answer"+b]&&a["answer"+b]!==e.defaulting_flag?a["answer"+b]:a["question"+b]:""},find_aspectratio:function(a){var b=a.match(/height="\d+"/);if(!b[0]){console.log("Your video embed code needs a height.");return}b=parseInt(b[0].replace(/height="/,"").replace(/"/,""));var c=a.match(/width="\d+"/);if(!c[0]){console.log("Your video embed code needs a width.");return}return c=parseInt(c[0].replace(/width="/,"").replace(/"/,"")),b/c*100},get_possible_answers:function(a,b){var c=[],d=b?"right":"wrong";a[d]&&c.push(e.make_possible_answer(a,"",b));for(var f=0;f<10;f++)a[d+f]&&c.push(e.make_possible_answer(a,f,b));return c},make_possible_answer:function(a,b,c){var d=c?"right":"wrong";return{answer:a[d+b],correct:c,title:e.pull_answer_value_from_spreadsheet(a,"title",b,c),subhed:e.pull_answer_value_from_spreadsheet(a,"subhed",b,c),text:e.pull_answer_value_from_spreadsheet(a,"text",b,c),topimage:e.pull_answer_value_from_spreadsheet(a,"topimage",b,c),topvideoembed:e.pull_answer_value_from_spreadsheet(a,"topvideoembed",b,c),middleimage:e.pull_answer_value_from_spreadsheet(a,"middleimage",b,c),middlevideoembed:e.pull_answer_value_from_spreadsheet(a,"middlevideoembed",b,c),bottomimage:e.pull_answer_value_from_spreadsheet(a,"bottomimage",b,c),bottomvideoembed:e.pull_answer_value_from_spreadsheet(a,"bottomvideoembed",b,c),backgroundimage:e.pull_answer_value_from_spreadsheet(a,"backgroundimage",b,c)}},make_quiz_data_from_spreadsheet_data:function(a){var b=[];for(var c=0;c<a.length;c++){var d=a[c],f=e.get_possible_answers(d,!1),g=e.get_possible_answers(d,!0),h=[];for(var i=0;i<g.length;i++)h.push(Math.round(Math.random()*f.length));h.sort();var j=[],k=0;for(var i=0;i<=f.length;i++){while(i===h[k])j.push(g[k]),k++;if(i===f.length)continue;j.push(f[i])}var l={question:{title:d.questiontitle,subhed:d.questionsubhed,text:d.questiontext,topimage:d.questiontopimage,topvideoembed:d.questiontopvideoembed,middleimage:d.questionmiddleimage,middlevideoembed:d.questionmiddlevideoembed,bottomimage:d.questionbottomimage,bottomvideoembed:d.questionbottomvideoembed,backgroundimage:d.questionbackgroundimage},possible_answers:j,rowNumber:d.rowNumber-1};b.push(l)}return b},append_question:function(a){var b=e.quiz_data[a],c=jQuery('<li class="question_container row-fluid question_'+a+'"></li>');c.append(e.build_question_element_from_row(b)),c.append(e.build_possible_answer_elements_from_row(b,a)),d.append(c)},build_question_element_from_row:function(a){return jQuery('<div class="question span12 show" style="overflow: hidden; position: relative;"> '+e.create_slide_guts(a.question)+"</div>")},create_slide_guts:function(a){var b="";for(var c=0;c<e.possible_display_values.length;c++){var d=e.possible_display_values[c];b+=e.create_display_element(d,a)}return b},build_possible_answer_elements_from_row:function(b,c){var d=jQuery('<ul class="span12 possible_answers possible_answers_'+c+'"></ul>');for(var g=0;g<b.possible_answers.length;g++){var h=b.possible_answers[g],i=jQuery('<li class="possible_answer span12 answer_'+g+'">'+h.answer+"</li>");(function(b,c,g){g.bind("click",function(){var g=e.quiz_data[b].possible_answers[c].correct;d.find(".selected").removeClass("selected"),a(this).addClass("selected"),a(this).removeClass("possible_answer"),d.find(".answer_"+c).addClass(g?"correct_answer":"wrong_answer"),typeof f[b]=="undefined"&&(f[b]=g,e.update_correct_answers_element(),cover.find(".question_"+b).addClass("first_guess_"+(g?"right":"wrong"))),e.display_answer(e.quiz_data[b],b,e.quiz_data[b].possible_answers[c]),e.quiz_data[b].previously_selected=e.quiz_data[b].possible_answers[c]})})(c,g,i),d.append(i)}return d},possible_display_values:["backgroundimage","topimage","topvideoembed","title","middleimage","middlevideoembed","subhed","text","bottomimage","bottomvideoembed"],add_display_in_correct_place:function(a,b,c){for(var d=b;d>0;d--)if(a.find("."+e.possible_display_values[d-1]).length){a.find("."+e.possible_display_values[d-1]).after(e.create_display_element(e.possible_display_values[b],c));return}a.prepend(e.create_display_element(e.possible_display_values[b],c))},create_display_element:function(a,b){switch(a){case"backgroundimage":return b[a]?'<div class="'+a+'" style="background-image: url(\''+b[a]+"'); height: 100%; width: 100%;position:absolute;z-index: -1\"></div>":"";case"topimage":return b[a]?'<img src="'+b[a]+'" class="'+a+'"></img>':"";case"topvideoembed":return b.topaspectratio?'<div class="videoembed '+a+'" style="padding-bottom:'+b.topaspectratio+'%">'+b[a]+"</div>":"";case"title":return b[a]?'<h1 class="'+a+'">'+b[a]+"</h1>":"";case"middleimage":return b[a]?'<img src="'+b[a]+'" class="'+a+'"></img>':"";case"middlevideoembed":return b.middleaspectratio?'<div class="videoembed '+a+'" style="padding-bottom:'+b.middleaspectratio+'%">'+b[a]+"</div>":"";case"subhed":return b[a]?'<h2 class="'+a+'">'+b[a]+"</h2>":"";case"text":return'<p class="'+a+'">'+b[a]+"</p>";case"bottomimage":return b[a]?'<img src="'+b[a]+'" class="'+a+'"></img>':"";case"bottomvideoembed":return b.bottomaspectratio?'<div class="videoembed" style="padding-bottom:'+b.bottomaspectratio+'%">'+b[a]+"</div>":""}},display_answer:function(a,b,c){var f=a.previously_selected?a.previously_selected:a.question,g=d.find(".question_"+b+" .question");g.addClass("revealed_answer");for(var h=0;h<e.possible_display_values.length;h++){var i=e.possible_display_values[h];c[i]!=f[i]&&(c[i]?f[i]?g.find("."+i).before(jQuery(e.create_display_element(i,c))).remove():e.add_display_in_correct_place(g,h,c):g.find("."+i).remove())}},create_cover:function(){cover=a("#"+e.container),d=jQuery("<ul></ul>"),cover.append(d),d.addClass("quiz_container"),d.css("padding","0px")},update_correct_answers_element:function(){var a=0;for(var b=0;b<e.quiz_data.length;b++)f[b]&&a++;g.text(a)}};return h.init(b,c)},a.fn.quiz=function(b,c){return c=c||{},c.container=this.attr("id"),this.quiz=a.quiz(b,c),this}})(jQuery);