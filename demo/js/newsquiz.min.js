/*! newsquiz - v0.1.0 - 2013-11-21 
* https://github.com/motherjones/newsquiz
* Copyright (c) 2013 Ben Breedlove; Licensed MIT, GPL */
!function(a){a.quiz=function(b,c){var d,e,f,g,h=[],i={defaulting_behavior_on:!0,defaulting_flag:"!default",container:"quiz_container",possible_display_elements:[{name:"backgroundimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<div class="'+this.name+'" style="background-image: url(\''+b[this.name]+"'); height: 100%; width: 100%;position:absolute;z-index: -1\"></div>"):""}},{name:"topimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<img src="'+b[this.name]+'" class="'+this.name+'"></img>'):""}},{name:"topvideoembed",finder:function(a){return a.find("."+this.name)},needs_aspect_ratio:!0,create_element:function(b){return b.topvideoembedaspectratio?a('<div class="videoembed '+this.name+'" style="padding-bottom:'+b.topvideoembedaspectratio+'%">'+b[this.name]+"</div>"):""}},{name:"title",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<h1 class="'+this.name+'">'+b[this.name]+"</h1>"):""}},{name:"middleimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<img src="'+b[this.name]+'" class="'+this.name+'"></img>'):""}},{name:"middlevideoembed",needs_aspect_ratio:!0,finder:function(a){return a.find("."+this.name)},create_element:function(b){return b.middlevideoembedaspectratio?a('<div class="videoembed '+this.name+'" style="padding-bottom:'+b.middlevideoembedaspectratio+'%">'+b[this.name]+"</div>"):""}},{name:"subhed",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<h2 class="'+this.name+'">'+b[this.name]+"</h2>"):""}},{name:"text",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<p class="'+this.name+'">'+b[this.name]+"</p>"):""}},{name:"bottomimage",finder:function(a){return a.find("."+this.name)},create_element:function(b){return b[this.name]?a('<img src="'+b[this.name]+'" class="'+this.name+'"></img>'):""}},{name:"bottomvideoembed",needs_aspect_ratio:!0,finder:function(a){return a.find("."+this.name)},create_element:function(b){return b.bottomvideoembedaspectratio?a('<div class="videoembed '+this.name+'" style="padding-bottom:'+b.bottomvideoembedaspectratio+'%">'+b[this.name]+"</div>"):""}}],init:function(a,b){if(e=this,b)for(var c in b)e[c]=b[c];if("string"==typeof a)return e.make_quiz_from_google_spreadsheet(a),e;e.calculate_aspectratios(a),e.quiz_data=a,e.create_cover();for(var d=0;d<e.quiz_data.length;d++)e.append_question(d);return e.append_how_you_did_section(),e},append_how_you_did_section:function(){g=a('<span class="correct_answers">0</span>');var b=a('<p class="how_you_did"></p>');b.append(a("<span>You got </span>")),b.append(g),b.append(a("<span> correct answers out of "+e.quiz_data.length+" questions</span>")),f.append(b),f.append(a('<p class="small">on your first attempt. No fair changing your answers after you found out you were wrong</p>'))},make_quiz_from_google_spreadsheet:function(a){Tabletop.init({key:a,callback:function(a){var b=e.make_quiz_data_from_spreadsheet_data(a);e.init(b,c)},simpleSheet:!0})},calculate_aspectratios:function(a){for(var b=0;b<a.length;b++){for(var c=a[b],d=0;d<c.possible_answers.length;d++){var f=c.possible_answers[d];e.find_aspectratio_for_each_type_of_video_embed(f)}e.find_aspectratio_for_each_type_of_video_embed(c.question)}},find_aspectratio_for_each_type_of_video_embed:function(a){for(var b=0;b<e.possible_display_elements.length;b++){var c=e.possible_display_elements[b];c.needs_aspect_ratio&&a[c.name]&&(a[c.name+"aspectratio"]=e.find_aspectratio(a[c.name]))}},find_aspectratio:function(a){var b=a.match(/height="\d+"/);if(!b||!b[0])return console.log("Your video embed code needs a height."),"";b=parseInt(b[0].replace(/height="/,"").replace(/"/,""),10);var c=a.match(/width="\d+"/);return c&&c[0]?(c=parseInt(c[0].replace(/width="/,"").replace(/"/,""),10),b/c*100):(console.log("Your video embed code needs a width."),"")},pull_answer_value_from_spreadsheet:function(a,b,c,d){return d=d?"right":"wrong",a[d+c+b]&&a[d+c+b]!==e.defaulting_flag?a[d+c+b]:e.defaulting_behavior_on&&a[d+c+b]!==e.defaulting_flag||!e.defaulting_behavior_on&&a[d+c+b]===e.defaulting_flag?a[d+b]&&a[d+b]!==e.defaulting_flag?a[d+b]:a["answer"+b]&&a["answer"+b]!==e.defaulting_flag?a["answer"+b]:a["question"+b]:""},get_possible_answers:function(a,b){var c=[],d=b?"right":"wrong";a[d]&&c.push(e.make_possible_answer(a,"",b));for(var f=0;10>f;f++)a[d+f]&&c.push(e.make_possible_answer(a,f,b));return c},make_possible_answer:function(a,b,c){for(var d=c?"right":"wrong",f={answer:a[d+b],correct:c},g=0;g<e.possible_display_elements.length;g++){var h=e.possible_display_elements[g].name;f[h]=e.pull_answer_value_from_spreadsheet(a,h,b,c)}return f},make_quiz_data_from_spreadsheet_data:function(a){for(var b,c=[],d=0;d<a.length;d++){var f=a[d],g=e.get_possible_answers(f,!1),h=e.get_possible_answers(f,!0),i=[];for(b=0;b<h.length;b++)i.push(Math.round(Math.random()*g.length));i.sort();var j=[],k=0;for(b=0;b<=g.length;b++){for(;b===i[k];)j.push(h[k]),k++;b!==g.length&&j.push(g[b])}var l={question:{},possible_answers:j,rowNumber:f.rowNumber-1};for(b=0;b<e.possible_display_elements.length;b++){var m=e.possible_display_elements[b].name;l.question[m]=f["question"+m]}c.push(l)}return c},append_question:function(b){var c=e.quiz_data[b],f=a('<li class="question_container row-fluid question_'+b+'"></li>');f.append(e.build_question_element_from_row(c)),f.append(e.build_possible_answer_elements_from_row(c,b)),d.append(f)},build_question_element_from_row:function(b){for(var c=a('<div class="question span12 show" style="overflow: hidden; position: relative;"></div>'),d=0;d<e.possible_display_elements.length;d++)c.append(e.possible_display_elements[d].create_element(b.question));return c},build_possible_answer_elements_from_row:function(b,c){function d(b,c,d){d.bind("click",function(){var d=e.quiz_data[b].possible_answers[c].correct;g.find(".selected").removeClass("selected"),a(this).addClass("selected"),a(this).removeClass("possible_answer"),g.find(".answer_"+c).addClass(d?"correct_answer":"wrong_answer"),"undefined"==typeof h[b]&&(h[b]=d,e.update_correct_answers_element(),f.find(".question_"+b).addClass("first_guess_"+(d?"right":"wrong"))),e.display_answer(e.quiz_data[b],b,e.quiz_data[b].possible_answers[c]),e.quiz_data[b].previously_selected=e.quiz_data[b].possible_answers[c]})}for(var g=a('<ul class="span12 possible_answers possible_answers_'+c+'"></ul>'),i=0;i<b.possible_answers.length;i++){var j=b.possible_answers[i],k=a('<li class="possible_answer span12 answer_'+i+'">'+j.answer+"</li>");d(c,i,k),g.append(k)}return g},add_display_in_correct_place:function(a,b,c){for(var d=b;d>0;d--)if(e.possible_display_elements[d-1].finder(a).length)return e.possible_display_elements[d-1].finder(a).after(e.possible_display_elements[b].create_element(c)),void 0;a.prepend(e.possible_display_elements[b].create_element(c))},display_answer:function(a,b,c){var f=a.previously_selected?a.previously_selected:a.question,g=d.find(".question_"+b+" .question");g.addClass("revealed_answer");for(var h=0;h<e.possible_display_elements.length;h++){var i=e.possible_display_elements[h].name;c[i]!==f[i]&&(c[i]?f[i]?e.possible_display_elements[h].finder(g).before(e.possible_display_elements[h].create_element(c)).remove():e.add_display_in_correct_place(g,h,c):e.possible_display_elements[h].finder(g).remove())}},create_cover:function(){f=a("#"+e.container),d=a("<ul></ul>"),f.append(d),d.addClass("quiz_container"),d.css("padding","0px")},update_correct_answers_element:function(){for(var a=0,b=0;b<e.quiz_data.length;b++)h[b]&&a++;g.text(a)}};return i.init(b,c)},a.fn.quiz=function(b,c){return c=c||{},c.container=this.attr("id"),this.quiz=a.quiz(b,c),this}}(jQuery);